# Инструкция по добавлению Support CRM сервера

## Шаги для активации

### 1. Добавьте сервер в конфигурацию

Откройте файл конфигурации MCP серверов (обычно `mcp-servers.json` в корне проекта или в папке пользователя).

Добавьте следующую конфигурацию:

```json
{
  "mcpServers": {
    "git": {
      "command": "node",
      "args": ["mcp-servers/git-server.js"]
    },
    "support-crm": {
      "command": "node",
      "args": ["mcp-servers/support-crm.js"]
    }
  }
}
```

### 2. Перезапустите приложение

```bash
# Остановите текущий dev server (Ctrl+C)
npm run dev
```

### 3. Подключите сервер в интерфейсе

1. Откройте приложение в браузере
2. В боковой панели найдите раздел MCP
3. Сервер `support-crm` должен появиться в списке
4. Нажмите "Connect" для подключения

### 4. Проверьте подключение

После подключения сервер должен показать статус "Connected" и предоставить следующие инструменты:

- `list_users` - список пользователей
- `get_user` - информация о пользователе
- `search_user` - поиск пользователя
- `get_user_tickets` - тикеты пользователя
- `get_ticket` - детали тикета
- `list_all_tickets` - все тикеты
- `create_ticket` - создать тикет
- `update_ticket` - обновить тикет

### 5. Загрузите FAQ в RAG

1. Откройте Knowledge Manager (иконка базы данных в sidebar)
2. Нажмите "Upload Files"
3. Выберите файл `docs/faq.md`
4. Нажмите "Build & Save Index"
5. Дождитесь завершения индексации

### 6. Создайте агента поддержки

1. Откройте настройки агентов
2. Создайте нового агента со следующими параметрами:

**Имя:** Support Assistant

**System Prompt:**

```
Ты - ассистент технической поддержки Legion. Твоя задача - помогать пользователям решать их проблемы.

ПРАВИЛА РАБОТЫ:
1. Всегда проверяй контекст пользователя и тикета, если он предоставлен
2. Используй базу знаний (FAQ) для ответов на типовые вопросы
3. Будь вежлив, эмпатичен и профессионален
4. Если не знаешь точного ответа - честно признайся и предложи связаться с техподдержкой
5. При решении проблемы давай пошаговые инструкции
6. Ссылайся на документацию, когда это уместно

ДОСТУПНЫЕ ИНСТРУМЕНТЫ:
Ты можешь использовать MCP инструменты для:
- Получения информации о пользователе (plan, история)
- Просмотра деталей тикета
- Создания новых тикетов
- Обновления статуса тикетов

Отвечай на русском языке, используя дружелюбный тон.
```

**RAG Mode:** Hybrid  
**RAG Threshold:** 0.3  
**Model:** gpt-4 или gpt-3.5-turbo

### 7. Используйте компонент SupportContext

В чате добавьте компонент `<SupportContext />` для выбора пользователя и тикета.

Компонент уже создан в `src/components/SupportContext.tsx`

## Тестовые сценарии

### Сценарий 1: Простой вопрос из FAQ

```
Пользователь: Как экспортировать данные?
Ожидается: Ответ из FAQ с инструкцией
```

### Сценарий 2: Вопрос с контекстом пользователя

```
1. Выберите пользователя: alexey.petrov@example.com
2. Выберите тикет: "Не работает авторизация через Google"
3. Спросите: "Почему не работает авторизация?"

Ожидается: Ответ учитывает, что это Pro пользователь с активным тикетом по OAuth
```

### Сценарий 3: Создание тикета через чат

```
Пользователь: Создай тикет для maria.ivanova@example.com про проблему с экспортом

Ожидается: Использование инструмента create_ticket
```

## Troubleshooting

**Сервер не подключается:**

- Проверьте, что файл `support-crm.js` исполняемый
- Убедитесь, что Node.js установлен
- Проверьте логи в консоли

**Нет данных о пользователях:**

- Убедитесь, что файл `support-data.json` существует
- Проверьте формат JSON

**RAG не находит информацию:**

- Убедитесь, что FAQ загружен в базу знаний
- Проверьте RAG threshold (сделайте ниже, н-р 0.2)
- Попробуйте переключить на Hybrid mode
